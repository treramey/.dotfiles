# Progress Log
PRD: task-loop-fzf
Started: 2026-01-15

## Codebase Patterns

### FZF Integration Pattern
- Use `fzf --prompt='...' --height=50% --reverse --no-sort` for interactive selection
- Handle cancel gracefully: `selected=$(...) || exit 0`
- Strip metadata from selection with `sed -E`
- See: `.config/tmux/tmux.conf` (sesh integration at line 34-36)

### JSON Parsing with jq
- Extract fields: `jq -r '.field // empty'` (gracefully handles missing fields)
- Count with filter: `jq '[.items[] | select(.condition)] | length'`
- Error handling: `2>/dev/null` suppresses jq parse errors

### State Directory Discovery
- Walk up from PWD: `while [[ "$dir" != "/" ]]; do ... dir="$(dirname "$dir")"; done`
- Check multiple locations: home (~/.opencode/state) + repo-local (.opencode/state)
- Deduplicate with: `sort -u`

---
<!-- Task logs below - APPEND ONLY -->

## Tasks - script-1, script-2, script-3
- Implemented all three tasks in single commit (interdependent functionality)
- Files changed: `.local/scripts/task-loop`
- **Learnings:**
  - `list_prds()` function discovers PRD files in both home and repo state directories
  - Walks up from PWD to find repo-local `.opencode/state` or `.claude/state`
  - Uses jq to parse JSON and calculate completion status (passed/total tasks)
  - Handles malformed JSON gracefully (shows `[?/?]`)
  - FZF integration: when no feature arg provided, launches picker with PRD list
  - User can cancel with ctrl-c/esc (exits cleanly with code 0)
  - Strips completion status suffix from selected PRD name with `sed -E 's/ \[[0-9?]+\/[0-9?]+\]$//'`
  - Backward compatibility preserved: `task-loop <feature>` still works
  - All flags (--tool, --max-iterations) unchanged
